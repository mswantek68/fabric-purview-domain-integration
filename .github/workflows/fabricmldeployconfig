name: Automate Fabric and AzureML Setup

on: [push]

jobs:
  setup-fabric-and-azureml:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Set up Azure CLI
      uses: azure/CLI@v1

    - name: Login to Azure
      run: az login --service-principal -u ${{ secrets.AZURE_CLIENT_ID }} -p ${{ secrets.AZURE_CLIENT_SECRET }} --tenant ${{ secrets.AZURE_TENANT_ID }}

    - name: Create Fabric Workspace
      id: create_workspace
      run: |
        workspace_name="my-fabric-workspace"
        resource_group="my-resource-group"
        location="eastus"
        az fabric workspace create --name $workspace_name --resource-group $resource_group --location $location
        workspace_id=$(az fabric workspace show --name $workspace_name --resource-group $resource_group --query id -o tsv)
        echo "::set-output name=workspace_id::$workspace_id"

    - name: Create Lakehouse
      id: create_lakehouse
      run: |
        lakehouse_name="my-lakehouse"
        workspace_id=${{ steps.create_workspace.outputs.workspace_id }}
        az fabric lakehouse create --name $lakehouse_name --workspace-id $workspace_id
        lakehouse_id=$(az fabric lakehouse show --name $lakehouse_name --workspace-id $workspace_id --query id -o tsv)
        echo "::set-output name=lakehouse_id::$lakehouse_id"

    - name: Create Folder in Lakehouse
      id: create_folder
      run: |
        lakehouse_name="my-lakehouse"
        workspace_id=${{ steps.create_workspace.outputs.workspace_id }}
        folder_name="my-aml-folder"
        az fabric lakehouse folder create --lakehouse-name $lakehouse_name --workspace-id $workspace_id --folder-name $folder_name
        abfs_path="abfs://$lakehouse_name@$workspace_id.dfs.fabric.microsoft.com/$folder_name"
        echo "::set-output name=abfs_path::$abfs_path"

    - name: Set Up AzureML Datastore
      run: |
        subscription_id="Your Azure Subscription ID"
        resource_group="Your Azure Machine Learning Service Workspace Resource Group"
        workspace_name="Your Azure Machine Learning Service Workspace Name"
        abfs_path=${{ steps.create_folder.outputs.abfs_path }}
        
        python - <<EOF
        from azure.identity import DefaultAzureCredential
        from azure.ai.ml import MLClient
        from azure.ai.ml.entities import OneLakeDatastore, OneLakeArtifact

        ml_client = MLClient(
            DefaultAzureCredential(),
            subscription_id="${subscription_id}",
            resource_group="${resource_group}",
            workspace="${workspace_name}"
        )

        artifact = OneLakeArtifact(
            name="my-lakehouse-id",
            type="lake_house"
        )
        store = OneLakeDatastore(
            name="onelake_lh_for_azureml",
            description="Credential-less OneLake datastore.",
            endpoint="msit-onelake.dfs.fabric.microsoft.com",
            artifact=artifact,
            one_lake_workspace_name="my-fabric-workspace"
        )

        ml_client.create_or_update(store)
        EOF
